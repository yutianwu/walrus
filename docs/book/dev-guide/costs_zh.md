# 存储成本

在 Walrus 主网上存储 blob 需要消耗 WAL 用于存储操作，以及 SUI 用于在 Sui 上执行交易。本节提供了相关成本的摘要，以及针对特定场景如何管理或最小化成本的建议。

本文档专门讨论存储成本。您可以在其他地方找到关于 [WAL 代币经济学](https://www.walrus.xyz/wal-token) 以及它在 [Walrus 委托权益证明系统](../walrus.pdf) 中作用的更广泛讨论。

## 理解 4 个成本来源

与 Walrus 存储相关的四个成本来源是获取存储资源、上传、Sui 交易和链上 Sui 对象：

- **存储资源。** 需要存储资源来存储 blob，具有适当的容量和时期持续时间。
  可以在系统有可用空间时从 Walrus 系统合约获取存储资源，需要一些 WAL。其他选项也可用，例如从补贴合约购买它们、进行转移，或将偶尔购买的较大资源拆分为较小的资源（见下面的讨论）。

- **上传成本。** 在 blob 注册时，会收取一些 WAL 来覆盖数据上传的成本。
  这确保了删除 blob 并重用相同的存储资源来存储新 blob 对系统是可持续的。

- **Sui 交易。** 存储 blob 涉及在 Sui 上最多三个链上操作。
  一个是获取存储资源，另一个（可能与第一个合并）注册 blob 并将其与 blob ID 关联，最后一个认证 blob 为可用。这些会产生一些 SUI 的 Sui gas 成本来覆盖计算成本。

- **链上对象。** 最后，Walrus blob 在链上表示为 Sui 对象。
  创建这些对象会将一些 SUI 存入 Sui 存储基金，当这些对象在不再需要后被删除时，大部分会被退还。

存储 blob 所需的存储资源大小，以及用于支付上传成本的大小，对应于 blob 的*编码大小*。blob 的编码大小是擦除编码 blob 的大小，大约比未编码的原始 blob 大小大 5 倍，以及一些与 blob 大小无关的元数据的大小。由于每个 blob 的固定大小元数据相当大（在最坏情况下约 64MB），存储小 blob（< 10MB）的成本主要由此决定，而存储较大 blob 的大小主要由其不断增加的大小决定。有关成本优化策略的更多信息，请参见[减少小 blob 的成本](#reducing-costs-for-small-blobs)。

Walrus CLI 使用一些策略来降低成本，但不保证对所有用例都是最优的。对于高量或其他成本敏感的用户，可能有进一步降低成本的策略，我们在下面讨论。

## 测量成本

<!-- WAL-723: Update this after changes are made to cost outputs. -->

测量特定大小存储成本的最准确方法是对相同大小的 blob 执行存储，并在 Sui 浏览器中观察 SUI 和 WAL 的成本（或直接通过 Sui RPC 调用）。Blob 内容不影响成本。

`walrus store <FILENAME> --epochs 1` 命令将产生 2 个交易：

- 第一个交易将执行 `reserve_space`（如果不存在适当大小的存储资源）和 `register_blob`；并将影响 SUI 和 WAL 的余额。

- 第二个将执行单个 `certify_blob` 调用，只会改变 SUI 余额。

您可以通过使用命令 `walrus burn-blobs --object-ids <BLOB_OBJECT_ID>` 销毁生成的 blob 对象，在浏览器上观察存储回扣。如下所述，在 Sui 上销毁对象不会删除 Walrus 上的 blob。

作为经验法则，`register_blob` 和 `certify_blob` 的 SUI 成本与 blob 大小或时期生命周期无关。`register_blob` 的 WAL 成本与 blob 的编码大小（擦除编码和元数据）成线性关系。对 `reserve_space` 的调用具有随时期数量增长的 SUI 成本，以及与编码大小和时期数量都成线性关系的 WAL 成本。

一些命令输出可以协助成本估算的信息，而无需提交交易：

- `walrus info` 命令显示从系统合约购买存储资源的当前成本以及上传成本。

- `walrus store --dry-run ...` 命令输出用于 WAL 成本计算的编码大小。`--dry-run` 参数确保不在链上提交交易。请注意，目前估算的 WAL 成本**不考虑补贴**，因此在有补贴可用时是高估的。

## 管理和最小化成本

有多种获取存储资源的方式，这影响它们的成本。

主要方式是向 Walrus 系统合约发送一些 WAL 来"购买"一定大小（以字节为单位）和定义生命周期（以时期为单位）的存储资源。目前，Walrus 基金会还运营一个补贴合约，允许以比系统合约更低的 WAL 成本获取存储资源。如果配置文件中包含补贴对象，Walrus CLI 和发布器默认使用补贴合约来降低成本。

此外，在获取存储资源之前，CLI 客户端将使用任何用户拥有的适当长度（以时期和字节大小为单位）的存储资源。但是，当前实现还没有尝试正确拆分或合并存储资源。
<!-- TODO(WAL-363): Update this as soon as better storage management is implemented. -->

有几种方法可以最小化与存储资源需求相关的成本。首先，从系统或补贴合约获取资源涉及至少一个 Sui 交易与相对复杂的共享对象 Sui 智能合约交互。因此，一次获取较大的存储资源（在长度和大小上）都可以最小化 SUI gas 成本。然后可以拆分和合并存储资源来存储较小的 blob 或较短时间的 blob。将多个智能合约调用打包到单个 Sui PTB 中来管理存储资源获取、拆分和合并也可以保持成本较低。

可以通过删除创建为*可删除*的未过期 blob 来回收和重用存储资源在其有效期的剩余时间内。因此，只需要存储数据少于完整时期倍数时间（主网上两周）的 dapp，可以通过积极删除 blob 并为其他 blob 重用存储来潜在地减少成本。

存储资源可以转移和交易，我们预见未来会存在其他市场和获取它们的方式。

注册 blob 和认证它们需要 SUI 来覆盖 gas 成本，以及 WAL 来覆盖上传成本。每个 blob 都需要经过这两个过程，因此对这些成本无能为力。然而，可以在单个 Sui PTB 中注册或认证多个 blob，以减少延迟，并在存储多个 blob 时可能减少成本。CLI 客户端在同时上传多个 blob 时使用这种方法。在同一个 PTB 内也可以执行存储资源管理操作来获取存储或拆分/合并存储资源，以进一步减少延迟和成本。

存储在 Walrus 上的每个 blob 也会创建一个表示 blob 的 Sui 对象。虽然这些对象不大且仅包含元数据，但 Sui 上的存储相对昂贵，对象成本可能累积。一旦 blob 有效期到期，blob 对象就没有用处，可以被销毁。这将回收与 Sui 上存储相关的大部分存储成本。

blob 对象用于管理 blob 生命周期，例如延长 blob 生命周期、删除它们以回收存储资源或添加属性。如果不再需要这些操作，可以通过 CLI 或智能合约调用销毁 blob 对象，以节省 Sui 存储成本。这不会删除 Walrus 上的 blob。根据 SUI 和 WAL 的相对成本，销毁长期存在的 blob 对象可能更便宜，然后在其生命周期接近结束时重新注册和重新认证它们以延长它。

### 减少小 blob 的成本

Walrus [Quilt](../usage/quilt.md) 是一个批量存储工具，可以减少小 blob 的存储成本。当多个 blob 一起存储时，元数据成本会在批次中摊销。Quilt 还可以显著减少 Sui 计算和存储成本，如[更低成本](../usage/quilt.md#lower-cost)部分所详述。

## 未来

Walrus 团队已计划通过使元数据更小来减少所有 blob 大小的成本的计划，以及进一步改进 Quilt 对小 blob 存储的效率。